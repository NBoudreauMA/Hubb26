<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HubbTIME ¬∑ Town of Hubbardston</title>
  <meta name="description" content="Town of Hubbardston ‚Äì Enhanced Biweekly Timesheet System" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèõÔ∏è</text></svg>" />
  <style>
:root {
  --forest-dark: #1a3d2e; --forest: #2d5a47; --sage: #4a7560; --sage-light: #6b9080;
  --meadow: #86a895; --cream: #f4f1e8; --ink: #2c2416; --bg: var(--cream);
  --panel: #fefcf8; --card: #ffffff; --muted: #6b6b47; --border: #d4cfc4;
  --shadow: rgba(45, 90, 71, 0.08); --accent: var(--forest); --accent-light: var(--sage);
  --success: #22c55e; --warning: #f59e0b; --error: #ef4444; --info: #3b82f6;
  --space-xs: 0.25rem; --space-sm: 0.5rem; --space-md: 1rem; --space-lg: 1.5rem;
  --space-xl: 2rem; --space-2xl: 3rem; --radius: 8px; --radius-lg: 12px; --transition: 0.2s ease;
}
[data-theme="dark"] {
  --bg: #0f1714; --panel: #111d18; --card: #13211b; --ink: #e7f2ec;
  --muted: #7aa892; --border: #1f2c27; --shadow: rgba(0, 0, 0, 0.25);
}
*, *::before, *::after { box-sizing: border-box; }
html, body {
  margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg); color: var(--ink); line-height: 1.6; min-height: 100vh; font-size: 16px;
}
h1, h2, h3 { margin: 0 0 var(--space-md) 0; font-weight: 600; line-height: 1.3; color: var(--accent); }
h1 { font-size: 2.2rem; } h2 { font-size: 1.8rem; } h3 { font-size: 1.4rem; }
p { margin: 0 0 var(--space-md) 0; }
.container { max-width: 1200px; margin: 0 auto; padding: var(--space-lg); }
.site-header {
  background: linear-gradient(135deg, var(--forest-dark) 0%, var(--forest) 100%);
  color: var(--cream); padding: var(--space-lg); box-shadow: 0 2px 8px var(--shadow);
  display: flex; align-items: center; gap: var(--space-lg); flex-wrap: wrap;
}
.brand { display: flex; align-items: center; gap: var(--space-md); }
.seal {
  width: 3rem; height: 3rem; background: var(--sage-light); color: var(--forest-dark);
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-weight: bold; font-size: 1.2rem; border: 2px solid var(--cream);
}
.site-title { font-size: 1.8rem; font-weight: 700; color: var(--cream); margin: 0; }
.tagline { color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; margin: 0; font-style: italic; }
.theme-toggle { margin-left: auto; }
.page-header { text-align: center; margin-bottom: var(--space-2xl); padding: var(--space-2xl) 0; }
.page-header h1 { font-size: 2.5rem; margin-bottom: var(--space-md); }
.page-header p { font-size: 1.1rem; color: var(--muted); }
.card {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-lg);
  margin-bottom: var(--space-xl); box-shadow: 0 2px 8px var(--shadow); overflow: hidden;
}
.card-header { padding: var(--space-lg); border-bottom: 1px solid var(--border); background: var(--panel); }
.card-title { margin: 0; color: var(--accent); font-size: 1.3rem; }
.card > :not(.card-header) { padding: var(--space-lg); }
.form-group { margin-bottom: var(--space-lg); }
.label { display: block; font-weight: 600; margin-bottom: var(--space-sm); color: var(--ink); }
.input, select, textarea {
  width: 100%; padding: var(--space-sm) var(--space-md); border: 1px solid var(--border);
  border-radius: var(--radius); background: var(--panel); color: var(--ink);
  font-size: 1rem; transition: var(--transition); font-family: inherit;
}
.input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(45, 90, 71, 0.1); }
.btn {
  display: inline-flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-md);
  border-radius: var(--radius); border: none; cursor: pointer; font-weight: 500; font-size: 0.95rem;
  transition: var(--transition); background: var(--accent); color: white;
}
.btn:hover { transform: translateY(-1px); box-shadow: 0 3px 8px var(--shadow); }
.btn.primary { background: var(--accent); }
.btn.secondary { background: var(--sage-light); color: var(--forest-dark); }
.btn.danger { background: var(--error); }
.btn.ghost { background: transparent; border: 1px solid var(--border); color: var(--ink); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.quick-actions {
  display: flex; gap: var(--space-sm); flex-wrap: wrap; margin-bottom: var(--space-lg);
  padding: var(--space-md); background: var(--panel); border-radius: var(--radius);
}
.table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); }
table { width: 100%; border-collapse: collapse; }
th, td { padding: var(--space-sm); text-align: left; border-bottom: 1px solid var(--border); }
th { background: var(--panel); font-weight: 600; }
tbody tr:hover { background: rgba(45, 90, 71, 0.05); }
table input, table select { width: 100%; min-width: 100px; margin: 0; padding: 4px 8px; font-size: 0.9rem; }
.row-actions { display: flex; gap: 4px; flex-wrap: wrap; }
.row-btn {
  padding: 2px 6px; font-size: 12px; border: 1px solid var(--border); background: var(--panel);
  border-radius: 4px; cursor: pointer; transition: var(--transition);
}
.row-btn:hover { background: var(--accent); color: white; }
.employee-info {
  background: linear-gradient(135deg, var(--sage-light) 0%, var(--meadow) 100%);
  color: var(--forest-dark); padding: var(--space-lg); border-radius: var(--radius-lg); margin-top: var(--space-md);
}
[data-theme="dark"] .employee-info { background: linear-gradient(135deg, var(--forest) 0%, var(--sage) 100%); color: var(--cream); }
.totals-panel {
  background: linear-gradient(135deg, var(--forest) 0%, var(--sage) 100%);
  color: var(--cream); padding: var(--space-xl); border-radius: var(--radius-lg); margin: var(--space-lg) 0;
}
.totals-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-md); }
.total-item { text-align: center; padding: var(--space-md); background: rgba(255, 255, 255, 0.1); border-radius: var(--radius); }
.total-label { font-size: 0.85rem; opacity: 0.9; margin-bottom: var(--space-xs); }
.total-value { font-size: 1.2rem; font-weight: 700; }
.alert { padding: var(--space-md); border-radius: var(--radius); margin-bottom: var(--space-md); border-left: 4px solid; }
.alert.info { background: rgba(59, 130, 246, 0.1); border-color: var(--info); color: var(--info); }
.alert.success { background: rgba(34, 197, 94, 0.1); border-color: var(--success); color: var(--success); }
.alert.error { background: rgba(239, 68, 68, 0.1); border-color: var(--error); color: var(--error); }
.alert.warning { background: rgba(245, 158, 11, 0.1); border-color: var(--warning); color: var(--warning); }
.text-center { text-align: center; }
.mt-md { margin-top: var(--space-md); }
.site-footer { background: var(--panel); border-top: 1px solid var(--border); margin-top: var(--space-2xl); padding: var(--space-lg); text-align: center; color: var(--muted); }
@media (max-width: 768px) {
  .container { padding: var(--space-md); }
  .site-header { padding: var(--space-md); flex-direction: column; }
  .quick-actions { flex-direction: column; }
}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="seal">H</div>
      <div>
        <h1 class="site-title">HubbTIME</h1>
        <p class="tagline">Town of Hubbardston ¬∑ Municipal Timesheet System</p>
      </div>
    </div>
    <div class="theme-toggle">
      <button id="themeToggle" class="btn ghost">Light</button>
    </div>
  </header>

  <main class="container">
    <header class="page-header">
      <h1>Enhanced Biweekly Timesheet</h1>
      <p>Smart timesheet system with automated calculations</p>
    </header>

    <form id="timesheetForm">
      <div id="systemMsg" class="alert info" style="display:none;"></div>

      <section class="card">
        <div class="card-header"><h2 class="card-title">Employee Information</h2></div>
        <div class="form-group">
          <label class="label" for="employeeSearch">Employee Name</label>
          <input id="employeeSearch" list="employeeList" class="input" placeholder="Start typing name..." autocomplete="off">
          <datalist id="employeeList"></datalist>
        </div>
        <div class="employee-info" id="employeeDetails" style="display:none;">
          <div class="totals-grid">
            <div class="total-item"><div class="total-label">Employee #</div><div class="total-value" id="empId">‚Äî</div></div>
            <div class="total-item"><div class="total-label">Name</div><div class="total-value" id="empName">‚Äî</div></div>
            <div class="total-item"><div class="total-label">Rate</div><div class="total-value" id="rate">‚Äî</div></div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header"><h2 class="card-title">Pay Period</h2></div>
        <div class="form-group">
          <label class="label" for="warrant">Select Pay Period</label>
          <select id="warrant" class="input" required>
            <option value="">Select Pay Period...</option>
          </select>
          <div id="warrantDetails" style="display:none; padding: var(--space-md); background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); margin-top: var(--space-sm);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-sm); font-size: 0.9rem;">
              <div><strong style="display:block; font-size:0.8rem; text-transform:uppercase; color:var(--muted); margin-bottom:4px;">Dates</strong><span id="warrantDates" style="font-weight:600;">‚Äî</span></div>
              <div><strong style="display:block; font-size:0.8rem; text-transform:uppercase; color:var(--muted); margin-bottom:4px;">Warrant Due</strong><span id="warrantDue" style="font-weight:600;">‚Äî</span></div>
              <div><strong style="display:block; font-size:0.8rem; text-transform:uppercase; color:var(--muted); margin-bottom:4px;">Check Date</strong><span id="warrantCheck" style="font-weight:600;">‚Äî</span></div>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header"><h2 class="card-title">Time Entries</h2></div>
        <div class="quick-actions">
          <button type="button" class="btn primary" id="addRowBtn">Add Row</button>
          <button type="button" class="btn secondary" id="townHallBtn">Town Hall Hours</button>
          <button type="button" class="btn secondary" id="sickBtn">Sick Day (8h)</button>
          <button type="button" class="btn secondary" id="vacationBtn">Vacation Day (8h)</button>
          <button type="button" class="btn secondary" id="holidayBtn">Holiday (8h)</button>
          <button type="button" class="btn danger" id="clearAllBtn">Clear All</button>
        </div>
        <div id="multiPositionAlert" class="alert info" style="display:none;">
          <strong>Multiple Positions:</strong> <span id="multiPositionText"></span>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Hours</th>
                <th>Type</th>
                <th>Description</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="timeBody"></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="card-header"><h2 class="card-title">Summary</h2></div>
        <div class="alert info" id="payTypeNote" style="margin-bottom: var(--space-lg);">
          <strong>Pay Calculation:</strong> <span id="payCalcText">Select an employee to see pay calculation method.</span>
        </div>
        <div class="totals-panel">
          <div style="display:flex; justify-content:space-between; margin-bottom:var(--space-md);">
            <div><div class="total-label">Total Hours</div><div id="totalHours" class="total-value">0.00</div></div>
            <div><div class="total-label">Estimated Pay</div><div id="grossPay" class="total-value">$0.00</div></div>
          </div>
        </div>
        <div class="totals-grid">
          <div class="total-item"><div class="total-label">Regular</div><div class="total-value" id="sumRegular">0.00</div></div>
          <div class="total-item"><div class="total-label">Sick</div><div class="total-value" id="sumSick">0.00</div></div>
          <div class="total-item"><div class="total-label">Vacation</div><div class="total-value" id="sumVacation">0.00</div></div>
          <div class="total-item"><div class="total-label">Holiday</div><div class="total-value" id="sumHoliday">0.00</div></div>
        </div>

        <!-- Fire Stipend input -->
        <div class="form-group" id="stipendGroup">
          <label class="label" for="stipendAmount">Fire Stipend (this pay period)</label>
          <input type="number" class="input" id="stipendAmount" min="0" step="0.01" placeholder="0.00">
          <small style="color:var(--muted)">Added to pay; not part of hours or GL split.</small>
        </div>
      </section>

      <section class="card" id="glSplitCard" style="display:none;">
        <div class="card-header"><h2 class="card-title">GL Account Split Required</h2></div>
        <div class="alert info">
          <strong>Multiple GL Accounts:</strong> Your hours must be allocated across different department GL codes below.
        </div>
        <div style="padding: var(--space-lg); background: var(--panel); border-radius: var(--radius); margin-bottom: var(--space-lg);">
          <div style="font-size: 1.1rem; margin-bottom: var(--space-sm);">
            <strong>Total Hours to Allocate:</strong> <span id="glSplitTotalHours" style="font-size: 1.3rem; font-weight: 700; color: var(--accent);">0.00</span>
          </div>
        </div>
        <div id="glSplitContainer"></div>
        <button type="button" class="btn secondary" id="addGLAccountBtn" style="margin-top: var(--space-md);">+ Add GL Account</button>
        <div id="glSplitStatus" style="margin-top: var(--space-lg); padding: var(--space-md); border-radius: var(--radius); text-align: center; font-weight: 600; border: 2px solid var(--warning); background: rgba(245, 158, 11, 0.1); color: var(--warning);">
          <div style="font-size: 1.1rem;">
            <span id="glAllocatedHours">0.00</span> / <span id="glTotalHours">0.00</span> hours allocated
          </div>
          <div style="font-size: 0.9rem; margin-top: var(--space-xs);">Please allocate all hours before submitting</div>
        </div>
      </section>

      <section class="card text-center">
        <button type="submit" class="btn primary" style="padding:var(--space-md) var(--space-xl); font-size:1.1rem;">Submit Timesheet</button>
        <div id="submitStatus" class="mt-md"></div>
      </section>
    </form>
  </main>

  <footer class="site-footer">
    <p>&copy; 2025 Town of Hubbardston, MA</p>
  </footer>

  <script>
(function() {
  'use strict';

  const FLOW_URL = "https://prod-58.usgovtexas.logic.azure.us:443/workflows/ceefc1e6e256421c9a5a83416ff6c167/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=lh1qRrhhVYUZ3ZhxuPpHYJPsdhdMmZDRSDndshkjiB0";

  const EMPLOYEES = [
    {id:3018,name:"Afonso Albert",rate:16.13,payType:"hourly"},{id:3216,name:"Afonso Nancy",rate:10.00,payType:"hourly"},
    {id:24,name:"Anderson Richard J",rate:8.96,payType:"hourly"},{id:2913,name:"Ares Erik R",rate:23.12,payType:"hourly"},
    {id:3009,name:"Ares James P",rate:22.35,payType:"hourly"},{id:2955,name:"Barbera Christine M",rate:31.82,payType:"hourly"},
    {id:3130,name:"Begin Betty Jane",rate:15.00,payType:"hourly"},{id:3110,name:"Blood Donald J",rate:36.82,payType:"hourly"},
    {id:3234,name:"Boudreau Nathan R",rate:115566,payType:"salary"},{id:3276,name:"Bourgeois Daniel F",rate:25.00,payType:"hourly"},
    {id:3236,name:"Bowley David D",rate:16.13,payType:"hourly"},{id:3181,name:"Brady Robert M",rate:16.89,payType:"hourly"},
    {id:3165,name:"Breagy Richard",rate:27.74,payType:"hourly"},{id:3215,name:"Breagy Susan",rate:20.00,payType:"hourly"},
    {id:3211,name:"Bresciani Andrew P",rate:28.36,payType:"hourly"},{id:3091,name:"Brown Travis M",rate:94242,payType:"salary"},
    {id:3277,name:"Capps Michael A",rate:22.00,payType:"hourly"},{id:2695,name:"Casey Troy A",rate:34.28,payType:"hourly"},
    {id:3226,name:"Champagne Robert",rate:23.46,payType:"hourly"},{id:3291,name:"Chatterton Samantha Lee",rate:32.50,payType:"hourly"},
    {id:3205,name:"Colwell Bryan R",rate:17.84,payType:"hourly"},{id:3220,name:"Como Jeannine",rate:20.00,payType:"hourly"},
    {id:3252,name:"Connery Julia A",rate:18.00,payType:"hourly"},{id:1034,name:"Coppola Anthony T",rate:5.00,payType:"hourly"},
    {id:3233,name:"Cormier Elizabeth",rate:15.00,payType:"hourly"},{id:2836,name:"Couture Ryan P",rate:25.00,payType:"hourly"},
    {id:3261,name:"Cunningham Brian F",rate:50.00,payType:"hourly"},{id:3000,name:"DeMalia John A Jr",rate:18.84,payType:"hourly"},
    {id:3283,name:"Dion Trevor R",rate:15.62,payType:"hourly"},{id:2567,name:"Dixson James F",rate:24.67,payType:"hourly"},
    {id:1156,name:"Dixson Tina C",rate:22.21,payType:"hourly"},{id:2532,name:"Doane William",rate:9.28,payType:"hourly"},
    {id:3297,name:"Ellis James",rate:20.00,payType:"hourly"},{id:3186,name:"Fontaine Kayla A",rate:20.68,payType:"hourly"},
    {id:2722,name:"Forte Robert K",rate:37.68,payType:"hourly"},{id:3180,name:"Gallant Edward R",rate:16.13,payType:"hourly"},
    {id:2997,name:"Gemborys Eric A",rate:25.00,payType:"hourly"},{id:3239,name:"Goewey Anne",rate:17.57,payType:"hourly"},
    {id:3168,name:"Goguen Neil B",rate:28.42,payType:"hourly"},{id:3230,name:"Goldsmith Gregory",rate:22.00,payType:"hourly"},
    {id:3255,name:"Gonzalez Izaiah",rate:17.43,payType:"hourly"},{id:3033,name:"Goscila Jeremy D",rate:28.56,payType:"hourly"},
    {id:3221,name:"Gosson Edward M",rate:20.00,payType:"hourly"},{id:3248,name:"Gosson Wendy",rate:18.00,payType:"hourly"},
    {id:2726,name:"Green Joyce E",rate:15.31,payType:"hourly"},{id:3266,name:"Green Melody",rate:56610,payType:"salary"},
    {id:3237,name:"Green Richard W",rate:22.00,payType:"hourly"},{id:2801,name:"Halkola James F",rate:23.46,payType:"hourly"},
    {id:2708,name:"Hamel Dennis C",rate:23.30,payType:"hourly"},{id:3155,name:"Hardaker Sharon A",rate:18.92,payType:"hourly"},
    {id:3256,name:"Hawkins Leroy",rate:20.00,payType:"hourly"},{id:2698,name:"Hayes Robert Jr",rate:100462,payType:"salary"},
    {id:3295,name:"Horne David",rate:50.00,payType:"hourly"},{id:3218,name:"Horvath Kenneth",rate:22.00,payType:"hourly"},
    {id:3254,name:"Hulette John",rate:17.52,payType:"hourly"},{id:3281,name:"Isgro Wendy",rate:15.00,payType:"hourly"},
    {id:3222,name:"Jeneski Linda",rate:18.00,payType:"hourly"},{id:3260,name:"Johnson Robert A",rate:50.00,payType:"hourly"},
    {id:3200,name:"Johnson Stanley H",rate:15.51,payType:"hourly"},{id:2937,name:"Kaldera Bella M",rate:15.00,payType:"hourly"},
    {id:3272,name:"Kamataris William",rate:22.00,payType:"hourly"},{id:3299,name:"Kelley Royce J",rate:23.98,payType:"hourly"},
    {id:3214,name:"Kohlstrom Beverly",rate:18.00,payType:"hourly"},{id:3243,name:"LaBelle Michael",rate:19.05,payType:"hourly"},
    {id:3189,name:"Lafayette Rene M",rate:20.00,payType:"hourly"},{id:3175,name:"Lamoureux Patricia",rate:15.00,payType:"hourly"},
    {id:3225,name:"Lanciani Robert",rate:41.09,payType:"hourly"},{id:2957,name:"Larson Shonna L",rate:15.00,payType:"hourly"},
    {id:3257,name:"LeBlanc Wendy",rate:22.03,payType:"hourly"},{id:3244,name:"Leroux Mary",rate:69993,payType:"salary"},
    {id:3219,name:"Listovitch Cynthia",rate:18.00,payType:"hourly"},{id:3238,name:"Lowe Patricia Erin",rate:23.38,payType:"hourly",multiPosition:true},
    {id:3119,name:"Mabardy Mitchell F",rate:20.82,payType:"hourly"},{id:3250,name:"Malcomson Evonne",rate:18.00,payType:"hourly"},
    {id:3016,name:"Malnati Nicholas",rate:23.46,payType:"hourly"},{id:3290,name:"McDaniel Isaiah",rate:16.89,payType:"hourly"},
    {id:3287,name:"McDonald Brendan R",rate:23.98,payType:"hourly"},{id:3263,name:"Michals Lorraine",rate:15.00,payType:"hourly"},
    {id:3279,name:"Moses Leeanne",rate:23.38,payType:"hourly",multiPosition:true},{id:2615,name:"O'Donnell Judith L",rate:4.75,payType:"hourly"},
    {id:3294,name:"Osowski Liberty",rate:18.00,payType:"hourly"},{id:3253,name:"Page Deborah",rate:18.00,payType:"hourly"},
    {id:3132,name:"Parker Michael C",rate:18.84,payType:"hourly"},{id:3171,name:"Payson James V",rate:16.89,payType:"hourly"},
    {id:3166,name:"Perron Nancy A",rate:22.03,payType:"hourly"},{id:3076,name:"Pervier Florence",rate:8.00,payType:"hourly"},
    {id:3249,name:"Pervier Paul",rate:20.00,payType:"hourly"},{id:3193,name:"Pierce Michael R",rate:20.68,payType:"hourly"},
    {id:3024,name:"Provencal Claudia G",rate:25.00,payType:"hourly"},{id:3274,name:"Rish Sara",rate:24.01,payType:"hourly"},
    {id:3049,name:"Rogan Nancy",rate:15.00,payType:"hourly"},{id:3296,name:"Saint Sadie",rate:22.00,payType:"hourly"},
    {id:3267,name:"Scarpato Samuel",rate:23.50,payType:"hourly"},{id:3259,name:"Seitz Benjamin",rate:25.49,payType:"hourly"},
    {id:3245,name:"Shampine Jeffrey G",rate:22.00,payType:"hourly"},{id:3143,name:"Shaughnessy Mary Ellen",rate:15.00,payType:"hourly"},
    {id:3289,name:"Siciliano Brian",rate:22.00,payType:"hourly"},{id:3235,name:"Siequist Shaun",rate:23.00,payType:"hourly"},
    {id:2732,name:"Sweeney Darrell M",rate:20.00,payType:"hourly"},{id:3093,name:"Sweeney Paul F",rate:17.57,payType:"hourly"},
    {id:3206,name:"Theriault Phillip J Jr",rate:17.80,payType:"hourly"},{id:3223,name:"Tonet Edward T",rate:20.00,payType:"hourly"},
    {id:3282,name:"Tyler Lois Ann",rate:15.00,payType:"hourly"},{id:3229,name:"Vincent James",rate:15.92,payType:"hourly"},
    {id:2848,name:"Vincent Kathleen Mary",rate:15.00,payType:"hourly"},{id:3275,name:"Wade Alexander",rate:45.00,payType:"hourly"},
    {id:3293,name:"White Tina",rate:22.03,payType:"hourly"},{id:3025,name:"Whitney Brianna H",rate:15.30,payType:"hourly"},
    {id:2750,name:"Whitney Carol W",rate:15.00,payType:"hourly"},{id:1045,name:"Wilkinson Lynn R",rate:15.00,payType:"hourly"},
    {id:3116,name:"Wilkinson Taylor",rate:29.40,payType:"hourly"},{id:3217,name:"Williams Lorraine",rate:18.00,payType:"hourly"},
    {id:3288,name:"Winchester Kenneth James",rate:23.98,payType:"hourly"},{id:2716,name:"Withycombe William R",rate:15.00,payType:"hourly"},
    {id:3123,name:"Wolfe Karen M",rate:8.00,payType:"hourly"},{id:3286,name:"Woodard Andrew P",rate:23.98,payType:"hourly"},
    {id:3077,name:"Woodward Patricia A",rate:12.75,payType:"hourly"},{id:3231,name:"Wright Lauren",rate:23.10,payType:"hourly"},
    {id:3292,name:"Wright Zakary Richard",rate:23.46,payType:"hourly"},{id:3285,name:"Young Hunter Allan",rate:17.57,payType:"hourly"}
  ];

  const MULTI_POSITION_EMPLOYEES = {
    "Lowe Patricia Erin": [
      {title: "Executive Assistant (Select Board)", glCode: "1000-122-5100-0000", rate: 23.38, weeklyHours: 26},
      {title: "Library Assistant", glCode: "1000-610-5100-0000", rate: 17.57, weeklyHours: 8}
    ],
    "Moses Leeanne": [
      {title: "Land Use Administrative", glCode: "1000-241-5100-0000", rate: 23.38, weeklyHours: 37},
      {title: "Assessor Administrative", glCode: "1000-141-5100-0000", rate: 23.38, weeklyHours: 31}
    ]
  };

  const WARRANTS = [
    {number:1,start:"2025-07-01",end:"2025-07-12",due:"2025-07-14",check:"2025-07-17"},
    {number:2,start:"2025-07-13",end:"2025-07-26",due:"2025-07-28",check:"2025-07-31"},
    {number:3,start:"2025-07-27",end:"2025-08-09",due:"2025-08-11",check:"2025-08-14"},
    {number:4,start:"2025-08-10",end:"2025-08-23",due:"2025-08-25",check:"2025-08-28"},
    {number:5,start:"2025-08-24",end:"2025-09-06",due:"2025-09-08",check:"2025-09-11"},
    {number:6,start:"2025-09-07",end:"2025-09-20",due:"2025-09-22",check:"2025-09-25"},
    {number:7,start:"2025-09-21",end:"2025-10-04",due:"2025-10-06",check:"2025-10-09"},
    {number:8,start:"2025-10-05",end:"2025-10-18",due:"2025-10-20",check:"2025-10-23"},
    {number:9,start:"2025-10-19",end:"2025-11-01",due:"2025-11-03",check:"2025-11-06"},
    {number:10,start:"2025-11-02",end:"2025-11-15",due:"2025-11-17",check:"2025-11-20"},
    {number:11,start:"2025-11-16",end:"2025-11-29",due:"2025-12-01",check:"2025-12-04"},
    {number:12,start:"2025-11-30",end:"2025-12-13",due:"2025-12-15",check:"2025-12-18"},
    {number:13,start:"2025-12-14",end:"2025-12-27",due:"2025-12-29",check:"2025-12-31"},
    {number:14,start:"2025-12-28",end:"2026-01-10",due:"2026-01-12",check:"2026-01-15"},
    {number:15,start:"2026-01-11",end:"2026-01-24",due:"2026-01-26",check:"2026-01-29"},
    {number:16,start:"2026-01-25",end:"2026-02-07",due:"2026-02-09",check:"2026-02-12"},
    {number:17,start:"2026-02-08",end:"2026-02-21",due:"2026-02-23",check:"2026-02-26"},
    {number:18,start:"2026-02-22",end:"2026-03-07",due:"2026-03-09",check:"2026-03-12"},
    {number:19,start:"2026-03-08",end:"2026-03-21",due:"2026-03-23",check:"2026-03-26"},
    {number:20,start:"2026-03-22",end:"2026-04-04",due:"2026-04-06",check:"2026-04-09"},
    {number:21,start:"2026-04-05",end:"2026-04-18",due:"2026-04-21",check:"2026-04-23"},
    {number:22,start:"2026-04-19",end:"2026-05-02",due:"2026-05-04",check:"2026-05-07"},
    {number:23,start:"2026-05-03",end:"2026-05-16",due:"2026-05-18",check:"2026-05-21"},
    {number:24,start:"2026-05-17",end:"2026-05-30",due:"2026-06-01",check:"2026-06-04"},
    {number:25,start:"2026-05-31",end:"2026-06-13",due:"2026-06-15",check:"2026-06-18"},
    {number:26,start:"2026-06-14",end:"2026-06-27",due:"2026-06-29",check:"2026-07-01"},
    {number:27,start:"2026-06-28",end:"2026-06-30",due:"2026-07-13",check:"2026-07-16"}
  ];

  const GL_ACCOUNTS = [
    {code: "1000-122-5100-0000", label: "Select Board"},{code: "1000-129-5100-0000", label: "Administration"},
    {code: "1000-141-5100-0000", label: "Assessors"},{code: "1000-149-5100-0000", label: "Treasurer/Collector"},
    {code: "1000-161-5100-0000", label: "Town Clerk"},{code: "1000-192-5100-0000", label: "Facilities"},
    {code: "1000-220-5100-0000", label: "Fire"},{code: "1000-241-5100-0000", label: "Land Use/Building"},
    {code: "1000-420-5100-0000", label: "Public Works"},{code: "1000-541-5100-0000", label: "Senior Center/COA"},
    {code: "1000-610-5100-0000", label: "Library"}
  ];

  let currentEmployee = null;
  let currentWarrant = null;
  let glSplitAllocations = [];

  const $ = (s) => document.querySelector(s);
  const currency = (n) => new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(Number(n || 0));
  
  const formatDate = (isoDate) => {
    if (!isoDate) return '‚Äî';
    const date = new Date(isoDate + 'T00:00:00');
    if (isNaN(date.getTime())) return '‚Äî';
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  };

  function showMessage(text, type = 'info') {
    const msg = $('#systemMsg');
    if (!msg) return;
    msg.className = 'alert ' + type;
    msg.textContent = text;
    msg.style.display = 'block';
    setTimeout(() => msg.style.display = 'none', 5000);
  }

  function timeDiffHours(start, end) {
    if (!start || !end) return 0;
    const [sh, sm] = start.split(':').map(Number);
    const [eh, em] = end.split(':').map(Number);
    let startMin = sh * 60 + sm;
    let endMin = eh * 60 + em;
    if (endMin < startMin) endMin += 24 * 60;
    return Math.round(((endMin - startMin) / 60) * 100) / 100;
  }

  function showGLSplitSection() {
    const card = $('#glSplitCard');
    if (card) card.style.display = 'block';
    initializeGLSplit();
  }

  function hideGLSplitSection() {
    const card = $('#glSplitCard');
    if (card) card.style.display = 'none';
    glSplitAllocations = [];
  }

  function initializeGLSplit() {
    const container = $('#glSplitContainer');
    if (!container) return;
    container.innerHTML = '';
    if (currentEmployee && MULTI_POSITION_EMPLOYEES[currentEmployee.name]) {
      const positions = MULTI_POSITION_EMPLOYEES[currentEmployee.name];
      positions.forEach(pos => {
        addGLSplitRow(pos.glCode, pos.weeklyHours * 2);
      });
    } else {
      addGLSplitRow();
    }
  }

  function addGLSplitRow(defaultCode = '', defaultHours = '') {
    const container = $('#glSplitContainer');
    if (!container) return;
    const rowId = 'gl-row-' + Date.now() + Math.random();
    const row = document.createElement('div');
    row.style.cssText = 'display:grid; grid-template-columns:1fr 120px auto; gap:var(--space-md); align-items:center; margin-bottom:var(--space-md); padding:var(--space-sm); background:var(--card); border-radius:var(--radius); border:1px solid var(--border);';
    const optionsHtml = GL_ACCOUNTS.map(gl => `<option value="${gl.code}" ${gl.code === defaultCode ? 'selected' : ''}>${gl.label} ‚Äî ${gl.code}</option>`).join('');
    row.innerHTML = `<select class="gl-account-select input" data-row-id="${rowId}" required><option value="">-- Select GL Account --</option>${optionsHtml}</select><input type="number" class="gl-hours-input input" data-row-id="${rowId}" step="0.25" min="0" placeholder="0.00" value="${defaultHours}" required><button type="button" class="btn danger" style="padding:6px 12px;" data-remove="${rowId}">Remove</button>`;
    container.appendChild(row);
    row.querySelector('.gl-account-select').addEventListener('change', validateGLSplit);
    row.querySelector('.gl-hours-input').addEventListener('input', validateGLSplit);
    row.querySelector(`[data-remove="${rowId}"]`).addEventListener('click', () => removeGLRow(rowId));
    validateGLSplit();
  }

  function removeGLRow(rowId) {
    const container = $('#glSplitContainer');
    if (!container) return;
    const rows = container.querySelectorAll('[data-row-id]');
    if (rows.length <= 2) {
      showMessage('You must have at least one GL account allocation', 'warning');
      return;
    }
    const row = container.querySelector(`[data-row-id="${rowId}"]`)?.closest('div');
    if (row && row.parentElement === container) {
      row.remove();
      validateGLSplit();
    }
  }

  function calculateGLSplitTotals() {
    const container = $('#glSplitContainer');
    if (!container) return { totalAllocated: 0, allocations: [] };
    let total = 0;
    const allocations = [];
    const rows = container.querySelectorAll('[data-row-id]');
    const seen = new Set();
    rows.forEach(el => {
      const id = el.getAttribute('data-row-id');
      if (seen.has(id)) return;
      seen.add(id);
      if (el.classList.contains('gl-account-select')) {
        const account = el.value || '';
        const hoursEl = container.querySelector(`.gl-hours-input[data-row-id="${id}"]`);
        const hours = parseFloat(hoursEl?.value || 0) || 0;
        if (account && hours > 0) {
          total += hours;
          allocations.push({ account, hours });
        }
      }
    });
    return { totalAllocated: total, allocations };
  }

  function validateGLSplit() {
    const totalHoursEl = $('#totalHours');
    const totalHours = parseFloat(totalHoursEl?.textContent || 0) || 0;
    const { totalAllocated, allocations } = calculateGLSplitTotals();
    const splitTotal = $('#glSplitTotalHours');
    if (splitTotal) splitTotal.textContent = totalHours.toFixed(2);
    const allocated = $('#glAllocatedHours');
    if (allocated) allocated.textContent = totalAllocated.toFixed(2);
    const total = $('#glTotalHours');
    if (total) total.textContent = totalHours.toFixed(2);
    glSplitAllocations = allocations;
    const status = $('#glSplitStatus');
    if (!status) return false;
    const diff = Math.abs(totalAllocated - totalHours);
    const isValid = diff < 0.01 && totalHours > 0;
    if (isValid) {
      status.style.cssText = 'margin-top:var(--space-lg); padding:var(--space-md); border-radius:var(--radius); text-align:center; font-weight:600; border:2px solid var(--success); background:rgba(34,197,94,0.1); color:var(--success);';
      status.innerHTML = '<div style="font-size: 1.1rem;"><span id="glAllocatedHours">' + totalAllocated.toFixed(2) + '</span> / <span id="glTotalHours">' + totalHours.toFixed(2) + '</span> hours allocated</div><div style="font-size: 0.9rem; margin-top: var(--space-xs);">‚úì Perfect! All hours allocated correctly.</div>';
      return true;
    } else if (totalAllocated > totalHours) {
      status.style.cssText = 'margin-top:var(--space-lg); padding:var(--space-md); border-radius:var(--radius); text-align:center; font-weight:600; border:2px solid var(--error); background:rgba(239,68,68,0.1); color:var(--error);';
      status.innerHTML = '<div style="font-size: 1.1rem;"><span id="glAllocatedHours">' + totalAllocated.toFixed(2) + '</span> / <span id="glTotalHours">' + totalHours.toFixed(2) + '</span> hours allocated</div><div style="font-size: 0.9rem; margin-top: var(--space-xs);">‚úó Over-allocated by ' + (totalAllocated - totalHours).toFixed(2) + ' hours. Please adjust.</div>';
      return false;
    } else {
      status.style.cssText = 'margin-top:var(--space-lg); padding:var(--space-md); border-radius:var(--radius); text-align:center; font-weight:600; border:2px solid var(--warning); background:rgba(245,158,11,0.1); color:var(--warning);';
      const msg = totalHours > 0 ? '‚ö† Under-allocated by ' + (totalHours - totalAllocated).toFixed(2) + ' hours. Please add more.' : 'Please allocate all hours before submitting.';
      status.innerHTML = '<div style="font-size: 1.1rem;"><span id="glAllocatedHours">' + totalAllocated.toFixed(2) + '</span> / <span id="glTotalHours">' + totalHours.toFixed(2) + '</span> hours allocated</div><div style="font-size: 0.9rem; margin-top: var(--space-xs);">' + msg + '</div>';
      return false;
    }
  }

  function handleEmployeeSelection(e) {
    const searchText = e.target.value.trim();
    const employee = EMPLOYEES.find(emp => emp.name.toLowerCase() === searchText.toLowerCase());
    if (employee) {
      currentEmployee = employee;
      const details = $('#employeeDetails');
      if (details) details.style.display = 'block';
      const empId = $('#empId');
      if (empId) empId.textContent = employee.id;
      const empName = $('#empName');
      if (empName) empName.textContent = employee.name;
      const rate = $('#rate');
      if (rate) {
        if (employee.payType === 'salary') {
          rate.textContent = currency(employee.rate) + ' annual';
        } else {
          rate.textContent = currency(employee.rate) + '/hr';
        }
      }
      const payCalcText = $('#payCalcText');
      if (payCalcText) {
        if (employee.payType === 'salary') {
          payCalcText.textContent = 'Salary: ' + currency(employee.rate) + ' annual = ' + currency(employee.rate/26) + ' biweekly (26 pay periods)';
        } else if (MULTI_POSITION_EMPLOYEES[employee.name]) {
          const positions = MULTI_POSITION_EMPLOYEES[employee.name];
          const desc = positions.map(p => p.weeklyHours + 'h/wk @ ' + currency(p.rate) + '/hr').join(' + ');
          payCalcText.textContent = 'Multi-position: ' + desc + '. Overtime at 1.5x over 80h per pay period.';
        } else {
          payCalcText.textContent = 'Hourly at ' + currency(employee.rate) + '/hr. Overtime (1.5x) over 80h per pay period.';
        }
      }
      if (MULTI_POSITION_EMPLOYEES[employee.name]) {
        showGLSplitSection();
        const multiAlert = $('#multiPositionAlert');
        const multiText = $('#multiPositionText');
        const positions = MULTI_POSITION_EMPLOYEES[employee.name];
        const posText = positions.map(p => p.title + ' (' + p.weeklyHours + 'h/wk @ ' + currency(p.rate) + '/hr)').join(' + ');
        if (multiText) multiText.textContent = posText;
        if (multiAlert) multiAlert.style.display = 'block';
        showMessage(employee.name + ' requires GL account split. Allocate hours at bottom.', 'info');
      } else {
        hideGLSplitSection();
        const multiAlert = $('#multiPositionAlert');
        if (multiAlert) multiAlert.style.display = 'none';
      }
      calculateTotals();
      showMessage('Selected: ' + employee.name, 'success');
    }
  }

  function addTimeRow(date = '', start = '', end = '', hours = '', type = 'Regular', desc = '') {
    const tbody = $('#timeBody');
    if (!tbody) return;
    
    if (!date && currentWarrant) {
      const existingDates = Array.from(document.querySelectorAll('.date-cell')).map(el => el.value).filter(d => d);
      const periodStart = new Date(currentWarrant.start + 'T00:00:00');
      const periodEnd = new Date(currentWarrant.end + 'T00:00:00');
      let candidateDate = new Date(periodStart);
      while (candidateDate <= periodEnd) {
        const dateStr = candidateDate.toISOString().slice(0, 10);
        if (!existingDates.includes(dateStr)) {
          date = dateStr;
          break;
        }
        candidateDate.setDate(candidateDate.getDate() + 1);
      }
      if (!date) date = currentWarrant.start;
    }
    
    const tr = document.createElement('tr');
    tr.innerHTML =
      '<td><input type="date" class="date-cell input" value="' + date + '"><div class="day-of-week" style="font-size:0.75rem; color:var(--muted); margin-top:2px;"></div></td>' +
      '<td><input type="time" class="time-start input" value="' + start + '"></td>' +
      '<td><input type="time" class="time-end input" value="' + end + '"></td>' +
      '<td><input type="number" step="0.25" min="0" class="time-hours input" value="' + hours + '" placeholder="0.00"></td>' +
      '<td><select class="time-type input">' +
        '<option' + (type === 'Regular' ? ' selected' : '') + '>Regular</option>' +
        '<option' + (type === 'Sick' ? ' selected' : '') + '>Sick</option>' +
        '<option' + (type === 'Vacation' ? ' selected' : '') + '>Vacation</option>' +
        '<option' + (type === 'Holiday' ? ' selected' : '') + '>Holiday</option>' +
      '</select></td>' +
      '<td><input type="text" class="input" placeholder="Description" value="' + desc + '"></td>' +
      '<td><button type="button" class="row-btn remove-row" style="background:var(--error);color:white;">Remove</button></td>';
    tbody.appendChild(tr);
    
    updateDayOfWeek(tr);
    
    if (start && end && type === 'Regular') {
      tr.querySelector('.time-hours').value = timeDiffHours(start, end).toFixed(2);
    }
    tr.querySelector('.remove-row').addEventListener('click', () => {
      tr.remove();
      calculateTotals();
    });
    
    const dateInput = tr.querySelector('.date-cell');
    if (dateInput) {
      dateInput.addEventListener('change', function() {
        updateDayOfWeek(tr);
        validateDateInPeriod(this);
      });
    }
    
    tr.querySelectorAll('input, select').forEach(input => {
      input.addEventListener('input', function() {
        const rowType = tr.querySelector('.time-type')?.value || 'Regular';
        if ((this.classList.contains('time-start') || this.classList.contains('time-end')) && rowType === 'Regular') {
          const s = tr.querySelector('.time-start')?.value || '';
          const e = tr.querySelector('.time-end')?.value || '';
          if (s && e) {
            tr.querySelector('.time-hours').value = timeDiffHours(s, e).toFixed(2);
          }
        }
        calculateTotals();
      });
    });
  }

  function updateDayOfWeek(row) {
    const dateInput = row.querySelector('.date-cell');
    const dayDisplay = row.querySelector('.day-of-week');
    if (dateInput && dayDisplay && dateInput.value) {
      const date = new Date(dateInput.value + 'T00:00:00');
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayDisplay.textContent = days[date.getDay()];
    }
  }

  function validateDateInPeriod(dateInput) {
    if (!currentWarrant || !dateInput.value) return;
    const enteredDate = new Date(dateInput.value + 'T00:00:00');
    const periodStart = new Date(currentWarrant.start + 'T00:00:00');
    const periodEnd = new Date(currentWarrant.end + 'T00:00:00');
    
    if (enteredDate < periodStart || enteredDate > periodEnd) {
      showMessage('Warning: Date ' + dateInput.value + ' is outside selected pay period (' + currentWarrant.start + ' to ' + currentWarrant.end + ')', 'warning');
      dateInput.style.borderColor = 'var(--warning)';
      dateInput.style.borderWidth = '2px';
    } else {
      dateInput.style.borderColor = '';
      dateInput.style.borderWidth = '';
    }
  }

  function clearAllRows() {
    const tbody = $('#timeBody');
    if (tbody) tbody.innerHTML = '';
    calculateTotals();
  }

  function addQuickDay(type, label, hours = '8.00') {
    if (!currentEmployee) {
      showMessage('Please select an employee first', 'error');
      return;
    }
    const today = new Date().toISOString().slice(0, 10);
    addTimeRow(today, '', '', hours, type, label);
    calculateTotals();
    showMessage(label + ' added', 'success');
  }

  function addTownHallHours() {
    if (!currentEmployee) {
      showMessage('Please select an employee first', 'error');
      return;
    }
    if (!currentWarrant) {
      showMessage('Please select a pay period first', 'error');
      return;
    }
    
    clearAllRows();
    
    const periodStart = new Date(currentWarrant.start + 'T00:00:00');
    const periodEnd = new Date(currentWarrant.end + 'T00:00:00');
    
    const schedule = {
      1: {start: "08:00", end: "16:00"},
      2: {start: "08:00", end: "18:00"},
      3: {start: "08:00", end: "16:00"},
      4: {start: "08:00", end: "16:00"}
    };
    
    for (let date = new Date(periodStart); date <= periodEnd; date.setDate(date.getDate() + 1)) {
      const dayOfWeek = date.getDay();
      if (schedule[dayOfWeek]) {
        const dateStr = date.toISOString().slice(0, 10);
        addTimeRow(dateStr, schedule[dayOfWeek].start, schedule[dayOfWeek].end, '', 'Regular', 'Town Hall hours');
      }
    }
    
    calculateTotals();
    showMessage('Town Hall hours added for pay period (Mon/Wed/Thu 8-4, Tue 8-6)', 'success');
  }

  function calculateTotals() {
    let total = 0, regular = 0, sick = 0, vacation = 0, holiday = 0;
    const rows = Array.from(document.querySelectorAll('#timeBody tr'));
    rows.forEach(row => {
      const hours = parseFloat(row.querySelector('.time-hours')?.value || 0) || 0;
      const type = row.querySelector('.time-type')?.value || 'Regular';
      if (!hours) return;
      total += hours;
      if (type === 'Regular') regular += hours;
      else if (type === 'Sick') sick += hours;
      else if (type === 'Vacation') vacation += hours;
      else if (type === 'Holiday') holiday += hours;
    });

    const setValue = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.textContent = value.toFixed(2);
    };
    setValue('totalHours', total);
    setValue('sumRegular', regular);
    setValue('sumSick', sick);
    setValue('sumVacation', vacation);
    setValue('sumHoliday', holiday);

    if (currentEmployee && MULTI_POSITION_EMPLOYEES[currentEmployee.name]) {
      validateGLSplit();
    }

    let grossPay = 0;
    if (currentEmployee) {
      if (currentEmployee.payType === 'salary') {
        grossPay = currentEmployee.rate / 26;
      } else if (currentEmployee.payType === 'hourly') {
        if (MULTI_POSITION_EMPLOYEES[currentEmployee.name] && glSplitAllocations.length > 0) {
          glSplitAllocations.forEach(allocation => {
            const position = MULTI_POSITION_EMPLOYEES[currentEmployee.name].find(p => p.glCode === allocation.account);
            const rate = position ? position.rate : currentEmployee.rate;
            grossPay += allocation.hours * rate;
          });
        } else {
          // ‚úÖ Overtime only after 80 regular hours in the biweekly pay period
          let overtime = 0;
          if (regular > 80) overtime = regular - 80;
          const regularPay = (regular - overtime) * currentEmployee.rate;
          const overtimePay = overtime * currentEmployee.rate * 1.5;
          const leavePay = (sick + vacation + holiday) * currentEmployee.rate;
          grossPay = regularPay + overtimePay + leavePay;
        }
      }
    }

    // Fire Stipend added to pay (not hours)
    const stipend = parseFloat($('#stipendAmount')?.value || 0) || 0;
    grossPay += stipend;

    const gpEl = document.getElementById('grossPay');
    if (gpEl) gpEl.textContent = currency(grossPay);
  }

  async function handleSubmit(e) {
    e.preventDefault();
    if (!currentEmployee) {
      showMessage('Please select an employee', 'error');
      return;
    }
    if (!currentWarrant) {
      showMessage('Please select a pay period', 'error');
      return;
    }

    if ($('#glSplitCard') && $('#glSplitCard').style.display !== 'none') {
      if (!validateGLSplit()) {
        showMessage('Please allocate all hours across GL accounts at the bottom.', 'error');
        return;
      }
    }

    if (currentEmployee && MULTI_POSITION_EMPLOYEES[currentEmployee.name]) {
      if (!validateGLSplit()) {
        showMessage('Please allocate all hours across GL accounts', 'error');
        return;
      }
    }

    const entries = [];
    const rows = Array.from(document.querySelectorAll('#timeBody tr'));
    rows.forEach(row => {
      const date = row.querySelector('.date-cell')?.value || '';
      const start = row.querySelector('.time-start')?.value || '';
      const end = row.querySelector('.time-end')?.value || '';
      const hours = parseFloat(row.querySelector('.time-hours')?.value || 0) || 0;
      const type = row.querySelector('.time-type')?.value || 'Regular';
      const description = row.children[5]?.querySelector('input')?.value || '';
      if (date && hours > 0) {
        entries.push({ date, start, end, hours, type, description });
      }
    });
    if (!entries.length) {
      showMessage('Add at least one time entry', 'error');
      return;
    }
    const payload = {
      employee: {
        id: currentEmployee.id,
        name: currentEmployee.name,
        rate: currentEmployee.rate,
        payType: currentEmployee.payType
      },
      payPeriod: {
        warrantNumber: currentWarrant.number,
        periodStart: currentWarrant.start,
        periodEnd: currentWarrant.end,
        dueDate: currentWarrant.due,
        checkDate: currentWarrant.check
      },
      entries: entries,
      totals: {
        totalHours: parseFloat($('#totalHours')?.textContent || 0),
        regularHours: parseFloat($('#sumRegular')?.textContent || 0),
        sickHours: parseFloat($('#sumSick')?.textContent || 0),
        vacationHours: parseFloat($('#sumVacation')?.textContent || 0),
        holidayHours: parseFloat($('#sumHoliday')?.textContent || 0),
        grossPay: $('#grossPay')?.textContent || '$0.00',
        stipend: parseFloat($('#stipendAmount')?.value || 0) || 0
      },
      glSplit: glSplitAllocations.length > 0 ? glSplitAllocations : null,
      multiPositionBreakdown: MULTI_POSITION_EMPLOYEES[currentEmployee.name] || null,
      submittedAt: new Date().toISOString(),
      source: "HubbTIME v1.0"
    };
    const submitBtn = document.getElementById('timesheetForm').querySelector('button[type="submit"]');
    const statusEl = $('#submitStatus');
    try {
      if (submitBtn) submitBtn.disabled = true;
      if (statusEl) statusEl.textContent = 'Submitting to Power Automate...';
      showMessage('Sending timesheet...', 'info');
      console.log('Submitting:', JSON.stringify(payload, null, 2));
      await fetch(FLOW_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      showMessage('Timesheet submitted to Power Automate!', 'success');
      if (statusEl) statusEl.textContent = '‚úì Submitted';
      setTimeout(() => {
        if (confirm('Timesheet submitted! Start new?')) {
          currentEmployee = null;
          currentWarrant = null;
          $('#employeeSearch').value = '';
          $('#employeeDetails').style.display = 'none';
          $('#warrant').value = '';
          $('#warrantDetails').style.display = 'none';
          hideGLSplitSection();
          clearAllRows();
          addTimeRow();
        }
      }, 2000);
    } catch (error) {
      console.error('Error:', error);
      showMessage('Error submitting: ' + error.message, 'error');
      if (statusEl) statusEl.textContent = 'Failed. Try again.';
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  }

  function initTheme() {
    const toggle = $('#themeToggle');
    if (!toggle) return;
    const saved = window.localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    toggle.textContent = saved === 'dark' ? 'Light' : 'Dark';
    toggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme');
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      toggle.textContent = newTheme === 'dark' ? 'Light' : 'Dark';
      window.localStorage.setItem('theme', newTheme);
    });
  }

  function init() {
    const employeeList = $('#employeeList');
    if (employeeList) {
      EMPLOYEES.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.name;
        option.label = emp.name + ' (#' + emp.id + ')';
        employeeList.appendChild(option);
      });
    }
    
    const warrantSelect = $('#warrant');
    if (warrantSelect) {
      WARRANTS.forEach(w => {
        const option = document.createElement('option');
        option.value = w.number;
        const startDate = new Date(w.start).toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
        const endDate = new Date(w.end).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
        option.textContent = 'Warrant ' + w.number + ' (' + startDate + ' - ' + endDate + ')';
        warrantSelect.appendChild(option);
      });
      
      warrantSelect.addEventListener('change', function() {
        const warrantNum = parseInt(this.value);
        currentWarrant = WARRANTS.find(w => w.number === warrantNum) || null;
        const details = $('#warrantDetails');
        if (currentWarrant && details) {
          details.style.display = 'block';
          const datesEl = $('#warrantDates');
          const dueEl = $('#warrantDue');
          const checkEl = $('#warrantCheck');
          if (datesEl) datesEl.textContent = formatDate(currentWarrant.start) + ' ‚Äì ' + formatDate(currentWarrant.end);
          if (dueEl) dueEl.textContent = formatDate(currentWarrant.due);
          if (checkEl) checkEl.textContent = formatDate(currentWarrant.check);
          showMessage('Selected: Warrant ' + currentWarrant.number + ' (' + currentWarrant.start + ' to ' + currentWarrant.end + ')', 'info');
        } else if (details) {
          details.style.display = 'none';
        }
      });
    }
    
    const empSearch = $('#employeeSearch');
    if (empSearch) {
      empSearch.addEventListener('input', handleEmployeeSelection);
      empSearch.addEventListener('change', handleEmployeeSelection);
    }
    addTimeRow();
    const addBtn = $('#addRowBtn');
    if (addBtn) addBtn.addEventListener('click', () => addTimeRow());
    const townHallBtn = $('#townHallBtn');
    if (townHallBtn) townHallBtn.addEventListener('click', addTownHallHours);
    const sickBtn = $('#sickBtn');
    if (sickBtn) sickBtn.addEventListener('click', () => addQuickDay('Sick', 'Sick Day'));
    const vacationBtn = $('#vacationBtn');
    if (vacationBtn) vacationBtn.addEventListener('click', () => addQuickDay('Vacation', 'Vacation Day'));
    const holidayBtn = $('#holidayBtn');
    if (holidayBtn) holidayBtn.addEventListener('click', () => addQuickDay('Holiday', 'Holiday'));
    const clearBtn = $('#clearAllBtn');
    if (clearBtn) clearBtn.addEventListener('click', () => {
      if (confirm('Clear all entries?')) {
        clearAllRows();
        addTimeRow();
        showMessage('Cleared', 'info');
      }
    });
    const addGLBtn = $('#addGLAccountBtn');
    if (addGLBtn) addGLBtn.addEventListener('click', () => addGLSplitRow());
    const form = $('#timesheetForm');
    if (form) form.addEventListener('submit', handleSubmit);

    // Recalculate when stipend changes
    $('#stipendAmount')?.addEventListener('input', calculateTotals);

    initTheme();
    showMessage('HubbTIME ready. Select employee to begin.', 'info');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
  </script>
</body>
</html>
